pipeline:
  hugo:
    image: cbrgm/drone-hugo:latest
    output: public
    validate: true

  minify:
    image: mysocialobservations/docker-tdewolff-minify
    commands:
      - >-
        minify --recursive --verbose --match=\.*.js$ --type=js --output public/ public/
      - >-
        minify --recursive --verbose --match=\.*.css$ --type=css --output public/ public/
      - >-
        minify --recursive --verbose --match=\.*.html$ --type=html --output public/ public/

  publish-docker:
    image: plugins/docker
    repo: jtreminio/jtreminio.com
    secrets: [ docker_username, docker_password ]
    tags:
      - latest
    dockerfile: ./build/Dockerfile
    context: ./

  scp:
    image: appleboy/drone-scp
    host: jtreminio.com
    username: root
    port: 22
    secrets: [ ssh_key ]
    target: /opt/docker-compose-jtreminio.com/
    source:
      - ./build/docker-compose.yml
    strip_components: 2

  deploy:
    image: appleboy/drone-ssh
    host: jtreminio.com
    username: root
    port: 22
    secrets: [ ssh_key ]
    script:
      - >-
        docker-compose \
          -f /opt/docker-compose-jtreminio.com/docker-compose.yml \
          pull
      - docker-compose \
          -f /opt/docker-compose-jtreminio.com/docker-compose.yml \
          up -d
